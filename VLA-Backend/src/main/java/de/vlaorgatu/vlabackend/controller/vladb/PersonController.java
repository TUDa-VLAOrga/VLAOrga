package de.vlaorgatu.vlabackend.controller.vladb;

import de.vlaorgatu.vlabackend.controller.sse.SseController;
import de.vlaorgatu.vlabackend.entities.vladb.Person;
import de.vlaorgatu.vlabackend.enums.sse.SseMessageType;
import de.vlaorgatu.vlabackend.exceptions.EntityNotFoundException;
import de.vlaorgatu.vlabackend.exceptions.InvalidParameterException;
import de.vlaorgatu.vlabackend.repositories.vladb.PersonRepository;
import java.util.Objects;
import lombok.AllArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

/**
 * Overrides to the default REST handlers generated by Spring Data REST.
 * The override is needed mainly to trigger SSE events on update operations.
 */
@AllArgsConstructor
@RestController
@RequestMapping("/api/persons")
public class PersonController implements
    DefaultGettingForJpaReposInterface<Person, PersonRepository> {

    /**
     * Repository used for person persistence operations.
     */
    private final PersonRepository personRepository;

    /**
     * A new person was born.
     *
     * @param person Dataset of the person to create. Must not contain an ID (auto-generated).
     * @return OK response with the created person, Error response otherwise.
     */
    @PostMapping
    public ResponseEntity<Person> createPerson(@RequestBody Person person) {
        if (Objects.nonNull(person.getId())) {
            if (person.getId() < 0) {
                person.setId(null);
            } else {
                throw new InvalidParameterException(
                    "Received person with ID " + person.getId() + " when creating a new person.");
            }
        }

        Person savedPerson = personRepository.save(person);
        SseController.notifyAllOfObject(SseMessageType.PERSONCREATED, savedPerson);
        return ResponseEntity.ok(savedPerson);
    }

    /**
     * Updates an existing person.
     *
     * @param id     ID of the person to update
     * @param person dataset for update. Must contain all keys, ID may be omitted.
     * @return OK response with updated person, Error response otherwise.
     */
    @PutMapping("/{id}")
    public ResponseEntity<Person> updatePerson(@PathVariable Long id, @RequestBody Person person) {
        if (Objects.isNull(person.getId())) {
            person.setId(id);
        } else if (!person.getId().equals(id)) {
            throw new InvalidParameterException(
                "Received inconsistent IDs on person modification. ID from url: " + id +
                    " vs. ID from body data: " + person.getId() + ".");
        }
        if (!personRepository.existsById(id)) {
            throw new EntityNotFoundException("Person with ID " + id + " not found.");
        }

        Person updatedPerson = personRepository.save(person);
        SseController.notifyAllOfObject(SseMessageType.PERSONUPDATED, updatedPerson);
        return ResponseEntity.ok(updatedPerson);
    }

    /**
     * Deletes a person by its ID.
     *
     * @param id ID of the person to delete
     * @return OK response with deleted person, Error response otherwise.
     */
    @DeleteMapping("/{id}")
    public ResponseEntity<Person> deletePerson(@PathVariable Long id) {
        Person deletedPerson = personRepository.findById(id).orElseThrow(
            () -> new EntityNotFoundException("Person with ID " + id + " not found."));

        personRepository.deleteById(id);
        SseController.notifyAllOfObject(SseMessageType.PERSONDELETED, deletedPerson);
        return ResponseEntity.ok(deletedPerson);
    }

    /**
     * Retrieves the repository ot this controller instance.
     *
     * @return The JPARepository used by this controller
     */
    @Override
    public PersonRepository getRepository() {
        return personRepository;
    }
}
